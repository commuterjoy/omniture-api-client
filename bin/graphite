#!/usr/bin/ruby 

require 'lib/omniture'
require 'lib/graphite'
require 'trollop'
        
#:api_key => '8664e458-9d62-4c8e-a55b-ad2f46d6e772',

args = Trollop::options do
    opt :report,     "Report id",                                :type => :int
    opt :host,       "Graphite host - Eg. graphite.guprod.gnl",  :type => :string
    opt :path,       "Prefix for all your metrics",              :type => :string
end

graphite = Graphite.new({
        :host => args[:host],
        :verbose => true
    })

report = Report.new().to_ganglia(args[:report])

report['metrics'].each { |metric|
    graphite.log({
            :path => [[:path].split('.'), 'omniture', metric['title'].gsub(/:/,'-').downcase].join('.'),
            :value => metric['breakdown'][:value]
    })
}
